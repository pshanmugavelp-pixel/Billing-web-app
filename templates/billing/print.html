<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tax Invoice</title>

<style>
@page { size: auto; margin: 8mm; }
@media print {
    body { zoom: 0.98; }
    tr { page-break-inside: avoid; }
}

* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    --font-base: 0.85rem;
    --font-small: 0.75rem;
    --font-large: 1.1rem;
    --pad-xs: 1px;
    --pad-sm: 2px;
    --border-thin: 1px;
    --border-thick: 1.5px;
    --seller-color: #1f3a8a;
}

body {
    font-family: Arial, sans-serif;
    font-size: var(--font-base);
    line-height: 1.4;
    color: #000;
}

.invoice {
    border: var(--border-thick) solid #000;
    padding: var(--pad-sm);
}

/* COLUMN CONTROLLER */
.col-sl { width: 3ch; }
.col-hsn { width: 8ch; }
.col-qty { width: 5ch; }
.col-price { width: 8ch; }
.col-taxable { width: 10ch; }
.col-total { width: 15ch; }
.col-item { width: auto; min-width: 50ch; }

.col-gst-pct { width: 1ch; text-align: center; padding: 0; }
.col-gst-amt { width: 2ch; text-align: right; padding: 0; }

.gst-block { width: 3in; min-width: 3in; max-width: 3in; }
.gst-cell { white-space: nowrap; text-align: center; }

table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
}

th, td {
    border: var(--border-thin) solid #000;
    padding: var(--pad-xs);
    font-size: var(--font-small);
}

th {
    font-weight: bold;
    text-align: center;
    font-size: var(--font-base);
}

.text-right { text-align: right; }
.text-center { text-align: center; }
.section { margin-top: 6px; }

/* SELLER HEADER */
.header {
    text-align: center;
    border-bottom: var(--border-thick) solid #000;
    padding-bottom: var(--pad-sm);
}

.header h1 {
    font-size: var(--font-large);
    font-weight: 800;
    color: var(--seller-color);
}

.header p {
    font-size: var(--font-small);
    font-weight: bold;
    color: var(--seller-color);
}

/* BILL TO / SHIP TO FONT */
.bill-address {
    font-size: 0.8rem;   /* â¬… increased safely */
    line-height: 1.45;
    font-weight: bold;
}

/* SEAL & SIGNATURE */
.seal-box {
    height: 90px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.seal-box img {
    max-height: 85px;
    max-width: 85px;
    object-fit: contain;
    filter: grayscale(100%) sepia(100%) saturate(300%) hue-rotate(200deg);
}

.sign-line {
    margin-top: 14px;
    padding-top: 4px;
    border-top: 1px solid #000;
    font-weight: bold;
    font-size: 0.65rem;
}
</style>
</head>

<body>
<div class="invoice">

<!-- SELLER -->
<div class="header">
    <h1>{{ seller['seller_name'] }}</h1>
    <p>{{ seller['address'] }}</p>
    <p>Mob: {{ seller['mobile'] }} | Email: {{ seller['email'] }}</p>
    <p>GSTIN: {{ seller['gst_number'] }}</p>
</div>

<div class="section text-center"><strong>TAX INVOICE</strong></div>

<!-- BILL HEADER -->
<table class="section">
<tr>
    <th colspan="2">Bill To</th>
    <th colspan="2">Ship To</th>
    <th>Invoice No</th>
    <td><strong>{{ bill['bill_id'] }}/24-25</strong></td>
</tr>
<tr>
    <td colspan="2" class="bill-address">
        {{ bill['customer_name'] }}<br>
        {{ bill['address'] }}<br>
        GST: {{ bill['gst_number'] or 'N/A' }}
    </td>
    <td colspan="2" class="bill-address">
        {{ bill['customer_name'] }}<br>
        {{ bill['address'] }}<br>
        GST: {{ bill['gst_number'] or 'N/A' }}
    </td>
    <th>Date</th>
    <td><strong>{{ bill['bill_date'] }}</strong></td>
</tr>
</table>

{% set has_igst = items|selectattr('igst','greaterthan',0)|list|length > 0 %}
{% set has_cgst_sgst = items|selectattr('cgst','greaterthan',0)|list|length > 0 %}
{% set gst_rate = items[0]['gst_percentage'] if items|length > 0 else 0 %}

{% set ns = namespace(total_qty=0,total_taxable=0,total_cgst=0,total_sgst=0,total_igst=0,total_amount=0) %}

<!-- ITEMS -->
<table class="section">
<thead>
<tr>
    <th rowspan="2" class="col-sl">Sl</th>
    <th rowspan="2" class="col-hsn">HSN</th>
    <th rowspan="2" class="col-item">ITEM NAME</th>
    <th rowspan="2" class="col-qty">QTY</th>
    <th rowspan="2" class="col-price">PRICE</th>
    <th rowspan="2" class="col-taxable">TAXABLE</th>
    {% if has_cgst_sgst %}<th colspan="4" class="gst-block">CGST / SGST</th>{% endif %}
    {% if has_igst %}<th colspan="2">IGST</th>{% endif %}
    <th rowspan="2" class="col-total">TOTAL</th>
</tr>
<tr>
{% if has_cgst_sgst %}
    <th class="col-gst-pct">%</th><th class="col-gst-amt">AMT</th>
    <th class="col-gst-pct">%</th><th class="col-gst-amt">AMT</th>
{% endif %}
{% if has_igst %}
    <th class="col-gst-pct">%</th><th class="col-gst-amt">AMT</th>
{% endif %}
</tr>
</thead>

<tbody>
{% for item in items %}
{% set taxable = item['quantity'] * item['unit_price'] %}
{% set ns.total_qty = ns.total_qty + item['quantity'] %}
{% set ns.total_taxable = ns.total_taxable + taxable %}
{% set ns.total_cgst = ns.total_cgst + item['cgst'] %}
{% set ns.total_sgst = ns.total_sgst + item['sgst'] %}
{% set ns.total_igst = ns.total_igst + item['igst'] %}
{% set ns.total_amount = ns.total_amount + item['total'] %}
<tr>
<td class="text-center">{{ loop.index }}</td>
<td>{{ item['hsn_code'] or '-' }}</td>
<td class="col-item">{{ item['product_name'] }}</td>
<td class="text-center">{{ item['quantity'] }}</td>
<td class="text-right">{{ "%.4f"|format(item['unit_price']) }}</td>
<td class="text-right">{{ "%.4f"|format(taxable) }}</td>
{% if has_cgst_sgst %}
<td class="gst-cell">{{ "%.2f"|format(item['gst_percentage']/2) }}%</td>
<td class="gst-cell text-right">{{ "%.4f"|format(item['cgst']) }}</td>
<td class="gst-cell">{{ "%.2f"|format(item['gst_percentage']/2) }}%</td>
<td class="gst-cell text-right">{{ "%.4f"|format(item['sgst']) }}</td>
{% endif %}
{% if has_igst %}
<td class="gst-cell">{{ "%.2f"|format(item['gst_percentage']) }}%</td>
<td class="gst-cell text-right">{{ "%.4f"|format(item['igst']) }}</td>
{% endif %}
<td class="text-right">{{ "%.4f"|format(item['total']) }}</td>
</tr>
{% endfor %}

<tr style="font-weight:bold;">
<td colspan="3" class="text-right">TOTAL</td>
<td class="text-center">{{ ns.total_qty }}</td>
<td></td>
<td class="text-right">{{ "%.4f"|format(ns.total_taxable) }}</td>
{% if has_cgst_sgst %}
<td class="gst-cell">{{ "%.2f"|format(gst_rate/2) }}%</td>
<td class="gst-cell text-right">{{ "%.4f"|format(ns.total_cgst) }}</td>
<td class="gst-cell">{{ "%.2f"|format(gst_rate/2) }}%</td>
<td class="gst-cell text-right">{{ "%.4f"|format(ns.total_sgst) }}</td>
{% endif %}
{% if has_igst %}
<td class="gst-cell">{{ "%.2f"|format(gst_rate) }}%</td>
<td class="gst-cell text-right">{{ "%.4f"|format(ns.total_igst) }}</td>
{% endif %}
<td class="text-right">
    {{ "%.4f"|format(ns.total_amount) }}<br>
    <small style="font-size: 0.5rem;">Round Off: {{ "%.2f"|format(bill['round_off']) }}</small><br>
    <strong>{{ "%.2f"|format(bill['total_amount']) }}</strong>
</td>
</tr>
</tbody>
</table>

<!-- BOTTOM : 3 BOXES -->
<table class="section">
<tr>
    <td colspan="4" style="font-size: var(--font-small);">
        <strong style="font-size: var(--font-base);">ACCOUNT DETAILS</strong><br><br>
        A/c Name: {{ seller['account_name'] }}<br>
        A/c No: {{ seller['account_number'] }}<br>
        IFSC: {{ seller['ifsc_code'] }}<br>
        Branch: {{ seller['branch'] }}
    </td>

    <td colspan="4" style="text-align:center; font-size: var(--font-small);">
        <strong style="font-size: var(--font-base);">
            RECEIVED GOODS IN GOOD CONDITION<br>
            AND ACKNOWLEDGED BY
        </strong>
        <div style="height:60px;"></div>
        CUSTOMER SIGNATURE
    </td>

    <td colspan="4" style="text-align:center;">
        <div class="seal-box">
        <img src="{{ url_for('static', filename='company_seal.png') }}">   
        </div>
        <div class="sign-line">AUTHORISED SIGNATORY</div>
    </td>
</tr>
</table>

</div>
</body>
</html>
