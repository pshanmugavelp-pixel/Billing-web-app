<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tax Invoice</title>

<style>
@page { size: auto; margin: 8mm; }
@media print { body { zoom: 0.98; } tr { page-break-inside: avoid; } }

:root {
    --font-base: 0.75rem;
    --font-small: 0.6rem;
    --font-large: 1.1rem;
    --pad-xs: 1px;
    --pad-sm: 2px;
    --border-thin: 1px;
    --border-thick: 1.5px;
    --seller-color: #1f3a8a;
}

body {
    font-family: Arial, sans-serif;
    font-size: var(--font-base);
    line-height: 1.4;
    margin: 0;
    color: #000;
}

.invoice {
    border: var(--border-thick) solid #000;
    padding: var(--pad-sm);
}

/* COLUMN CONTROL */
.col-sl { width: 3ch; }
.col-hsn { width: 6ch; }
.col-qty { width: 4ch; }
.col-price { width: 6ch; }
.col-taxable { width: 7ch; }
.col-total { width: 7ch; }
.col-item { width: auto; min-width: 36ch; }
.col-gst-pct { width: 3ch; padding: 0; text-align: center; }
.col-gst-amt { width: 5ch; padding: 0; text-align: right; }

table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
}

th, td {
    border: var(--border-thin) solid #000;
    padding: var(--pad-xs);
    word-break: break-word;
}

th { font-weight: bold; text-align: center; }
.text-right { text-align: right; }
.text-center { text-align: center; }
.section { margin-top: 6px; }

.header {
    text-align: center;
    border-bottom: var(--border-thick) solid #000;
    padding-bottom: var(--pad-sm);
}

.header h1 {
    margin: 0;
    font-size: var(--font-large);
    font-weight: 800;
    color: var(--seller-color);
}

.header p {
    margin: 2px 0;
    font-weight: bold;
    font-size: var(--font-small);
    color: var(--seller-color);
}

.signature-area {
    height: 60px;
    vertical-align: bottom;
    text-align: center;
    font-weight: bold;
}
</style>
</head>

<body>
<div class="invoice">

<div class="header">
    <h1>{{ seller['seller_name'] }}</h1>
    <p>{{ seller['address'] }}</p>
    <p>Mob: {{ seller['mobile'] }} | Email: {{ seller['email'] }}</p>
    <p>GSTIN: {{ seller['gst_number'] }}</p>
</div>

<div class="section text-center"><strong>TAX INVOICE</strong></div>

<table class="section">
<tr>
    <th colspan="2">Bill To</th>
    <th colspan="2">Ship To</th>
    <th>Invoice No</th>
    <td><strong>{{ bill['bill_id'] }}</strong></td>
</tr>
<tr>
    <td colspan="2">
        <strong>{{ bill['customer_name'] }}</strong><br>
        {{ bill['address'] }}<br>
        GST: {{ bill['gst_number'] or 'N/A' }}
    </td>
    <td colspan="2">
        <strong>{{ bill['customer_name'] }}</strong><br>
        {{ bill['address'] }}<br>
        GST: {{ bill['gst_number'] or 'N/A' }}
    </td>
    <th>Date</th>
    <td><strong>{{ bill['bill_date'] }}</strong></td>
</tr>
</table>

{% set has_igst = items|selectattr('igst','greaterthan',0)|list|length > 0 %}
{% set has_cgst_sgst = items|selectattr('cgst','greaterthan',0)|list|length > 0 %}

<table class="section">
<thead>
<tr>
    <th rowspan="2" class="col-sl">Sl</th>
    <th rowspan="2" class="col-hsn">HSN</th>
    <th rowspan="2" class="col-item">ITEM NAME</th>
    <th rowspan="2" class="col-qty">QTY</th>
    <th rowspan="2" class="col-price">PRICE</th>
    <th rowspan="2" class="col-taxable">TAXABLE</th>
    {% if has_cgst_sgst %}<th colspan="4">CGST / SGST</th>{% endif %}
    {% if has_igst %}<th colspan="2">IGST</th>{% endif %}
    <th rowspan="2" class="col-total">TOTAL</th>
</tr>
<tr>
{% if has_cgst_sgst %}
    <th class="col-gst-pct">%</th>
    <th class="col-gst-amt">AMT</th>
    <th class="col-gst-pct">%</th>
    <th class="col-gst-amt">AMT</th>
{% endif %}
{% if has_igst %}
    <th class="col-gst-pct">%</th>
    <th class="col-gst-amt">AMT</th>
{% endif %}
</tr>
</thead>

<tbody>
{% for item in items %}
{% set taxable = item['quantity'] * item['unit_price'] %}
<tr>
    <td class="text-center">{{ loop.index }}</td>
    <td>{{ item['hsn'] }}</td>
    <td class="col-item"><strong>{{ item['product_name'] }}</strong></td>
    <td class="text-center">{{ item['quantity'] }}</td>
    <td class="text-right">{{ "%.2f"|format(item['unit_price']) }}</td>
    <td class="text-right">{{ "%.2f"|format(taxable) }}</td>

{% if has_cgst_sgst %}
    <td class="text-center">{{ item['cgst_rate'] }}%</td>
    <td class="text-right">{{ "%.2f"|format(item['cgst']) }}</td>
    <td class="text-center">{{ item['sgst_rate'] }}%</td>
    <td class="text-right">{{ "%.2f"|format(item['sgst']) }}</td>
{% endif %}
{% if has_igst %}
    <td class="text-center">{{ item['igst_rate'] }}%</td>
    <td class="text-right">{{ "%.2f"|format(item['igst']) }}</td>
{% endif %}

    <td class="text-right"><strong>{{ "%.2f"|format(item['total']) }}</strong></td>
</tr>
{% endfor %}
</tbody>
</table>

<!-- TOTALS (DISPLAY ONLY â€“ CORRECT DATA) -->
<table class="section">
<tr>
    <th class="text-right" colspan="8">TAXABLE TOTAL</th>
    <td class="text-right col-total">{{ "%.2f"|format(bill['subtotal']) }}</td>
</tr>
<tr>
    <th class="text-right" colspan="8">GST TOTAL</th>
    <td class="text-right col-total">{{ "%.2f"|format(bill['gst_amount']) }}</td>
</tr>
<tr>
    <th class="text-right" colspan="8">GRAND TOTAL</th>
    <td class="text-right col-total"><strong>{{ "%.2f"|format(bill['total_amount']) }}</strong></td>
</tr>
</table>

<table class="section">
<tr>
    <td colspan="6">
        <strong>ACCOUNT DETAILS</strong><br>
        A/c Name: {{ seller['account_name'] }}<br>
        A/c No: {{ seller['account_number'] }}<br>
        IFSC: {{ seller['ifsc_code'] }}<br>
        Branch: {{ seller['branch'] }}
    </td>
    <td colspan="6" class="signature-area">
        COMPANY SEAL<br><br>
        AUTHORISED SIGNATORY
    </td>
</tr>
</table>

</div>
</body>
</html>
